<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live Sports TV (Cricfy-style) â€¢ Video.js + IPTV-org</title>

    <!-- Video.js CSS -->
    <link href="https://unpkg.com/video.js@8/dist/video-js.min.css" rel="stylesheet" />

    <style>
      :root { color-scheme: light dark; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        margin: 0; padding: 0; line-height: 1.5;
        background: #0b0f14; color: #e8edf2;
      }
      a { color: #7ecbff; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .muted { opacity: .85; }
      .danger { color: #ff7b7b; }
      .success { color: #5be49b; }

      header { padding: 12px 16px; background: #101722; border-bottom: 1px solid #1c2736; }
      header .topbar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
      header h1 { margin: 0; font-size: 16px; font-weight: 600; }

      .toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .toolbar input[type="text"], .toolbar button, .toolbar input[type="file"], .toolbar label {
        background: #0f1722; color: #e8edf2; border: 1px solid #233143; border-radius: 8px; padding: 8px 10px; font-size: 13px;
      }
      .toolbar button { cursor: pointer; }
      .toolbar button:hover { background: #132033; }

      .layout { display: grid; grid-template-columns: 320px 1fr; min-height: calc(100vh - 58px); }
      aside { border-right: 1px solid #1c2736; background: #0d131d; }
      main { padding: 14px 16px; }

      .panel { padding: 12px 12px; }
      .search-row { display: flex; gap: 8px; align-items: center; }
      .search-row input { flex: 1; }

      .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
      .chip { background: #0f1722; border: 1px solid #233143; padding: 6px 10px; border-radius: 999px; font-size: 12px; cursor: pointer; }
      .chip.active { background: #1a2a42; border-color: #365278; }

      .fav-toggle { display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; cursor: pointer; }

      .channels { margin-top: 10px; padding-right: 8px; max-height: calc(100vh - 220px); overflow: auto; }
      .channel-card { display: grid; grid-template-columns: 48px 1fr auto; gap: 10px; align-items: center; padding: 8px; border-radius: 10px; background: #0f1722; border: 1px solid #233143; margin-bottom: 8px; cursor: pointer; }
      .channel-card:hover { background: #132033; }
      .channel-logo { width: 48px; height: 48px; border-radius: 8px; object-fit: contain; background: #000; }
      .channel-title { font-size: 14px; font-weight: 600; }
      .channel-meta { font-size: 12px; opacity: .8; }
      .star { font-size: 18px; color: #f5d142; opacity: .8; }
      .star.inactive { opacity: .35; }

      .player-wrap { display: grid; grid-template-rows: auto 1fr; gap: 10px; }
      .video-js { width: 100%; height: 68vh; border-radius: 10px; overflow: hidden; background: #000; }
      .now-playing { font-size: 13px; opacity: .9; }

      footer { padding: 12px 16px; font-size: 12px; color: #c8d3df; opacity: 0.9; border-top: 1px solid #1c2736; }
    </style>
  </head>
  <body>
    <header>
      <div class="topbar">
        <h1>Live Sports TV (Cricfy-style)</h1>
        <div class="toolbar">
          <label title="Nepal-first sorting"><input id="nepalFirst" type="checkbox" checked /> Nepal-first</label>
          <input id="altUrl" type="text" placeholder="Paste .m3u URL (optional)" size="34" />
          <button id="loadUrlBtn" type="button">Load URL</button>
          <input id="localFile" type="file" accept=".m3u,.m3u8,text/plain" />
          <button id="reloadBtn" type="button">Reload</button>
        </div>
        <div id="status" class="muted">Status: Ready</div>
      </div>
    </header>

    <div class="layout">
      <aside>
        <div class="panel">
          <div class="search-row">
            <input id="search" type="text" placeholder="Search channels (e.g., Star Sports, Willow)" />
            <button id="clearSearch" title="Clear">âœ•</button>
          </div>
          <div class="chips" role="tablist" aria-label="Categories">
            <div class="chip active" data-cat="all">All</div>
            <div class="chip" data-cat="cricket">Cricket</div>
            <div class="chip" data-cat="football">Football</div>
          </div>
          <label class="fav-toggle"><input id="onlyFav" type="checkbox" /> Show only favorites â­</label>

          <div id="channelList" class="channels" aria-label="Channels list"></div>
        </div>
      </aside>

      <main>
        <div class="player-wrap">
          <div class="now-playing" id="nowPlaying">Now playing: â€”</div>
          <video id="videoPlayer" class="video-js vjs-default-skin" controls preload="auto" playsinline data-setup='{"fluid": true}'></video>
        </div>

        <section style="margin-top:16px;">
          <details>
            <summary>Notes: legal streams, CORS and geo</summary>
            <ul>
              <li><strong>Legal only</strong>: Uses channels listed by <a href="https://github.com/iptv-org/iptv" target="_blank" rel="noreferrer noopener">iptv-org/iptv</a> (MIT).</li>
              <li><strong>CORS</strong>: If blocked fetching the playlist, host the .m3u locally or use your own proxy. See README.</li>
              <li><strong>Geo</strong>: Some streams may be region-limited. For Nepal, keep Nepal-first enabled and prefer NP channels.</li>
            </ul>
          </details>
        </section>
      </main>
    </div>

    <footer>
      Built with <a href="https://videojs.com/" target="_blank" rel="noreferrer noopener">Video.js</a>. Data source: <a href="https://github.com/iptv-org/iptv" target="_blank" rel="noreferrer noopener">iptv-org/iptv</a> (MIT).
    </footer>

    <!-- Video.js JS -->
    <script src="https://unpkg.com/video.js@8/dist/video.min.js"></script>

    <script>
      const DEFAULT_PLAYLIST_URL = 'https://raw.githubusercontent.com/iptv-org/iptv/main/categories/sports.m3u';

      const statusEl = document.getElementById('status');
      const nepalFirstEl = document.getElementById('nepalFirst');
      const altUrlEl = document.getElementById('altUrl');
      const loadUrlBtn = document.getElementById('loadUrlBtn');
      const localFileEl = document.getElementById('localFile');
      const reloadBtn = document.getElementById('reloadBtn');

      const searchEl = document.getElementById('search');
      const clearSearchBtn = document.getElementById('clearSearch');
      const channelListEl = document.getElementById('channelList');
      const onlyFavEl = document.getElementById('onlyFav');
      const nowPlayingEl = document.getElementById('nowPlaying');

      const player = videojs('videoPlayer', { autoplay: false, controls: true, preload: 'auto', liveui: true, responsive: true, fluid: true });
      player.on('error', () => {
        const err = player.error();
        const msg = err && err.message ? err.message : 'Unknown playback error';
        alert('Stream failed to load. Please try another channel.\n\nDetails: ' + msg);
      });

      function setStatus(message, isError = false) {
        statusEl.innerHTML = (isError ? '<span class="danger">' : '<span class="success">') + message + '</span>';
      }

      // Flags for quick country visualization
      const CC_TO_FLAG = { NP: 'ğŸ‡³ğŸ‡µ', IN: 'ğŸ‡®ğŸ‡³', BD: 'ğŸ‡§ğŸ‡©', PK: 'ğŸ‡µğŸ‡°', LK: 'ğŸ‡±ğŸ‡°', BT: 'ğŸ‡§ğŸ‡¹', US: 'ğŸ‡ºğŸ‡¸', GB: 'ğŸ‡¬ğŸ‡§', AU: 'ğŸ‡¦ğŸ‡º', CA: 'ğŸ‡¨ğŸ‡¦' };
      function flagFor(cc) { return (CC_TO_FLAG[(cc || '').toUpperCase()] || ''); }

      // Parse EXTINF attributes and name
      function parseExtInfLine(line) {
        const attrs = {};
        const attrRegex = /([a-zA-Z0-9\-]+)="(.*?)"/g;
        let match;
        while ((match = attrRegex.exec(line)) !== null) attrs[match[1]] = match[2];
        const name = line.includes(',') ? line.split(',').pop().trim() : (attrs['tvg-name'] || 'Unknown');
        return { attrs, name };
      }

      function parseM3U(text) {
        const lines = text.split(/\r?\n/);
        const entries = [];
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line || !line.startsWith('#EXTINF:')) continue;
          const { attrs, name } = parseExtInfLine(line);
          let j = i + 1, url = '';
          while (j < lines.length) {
            const candidate = lines[j].trim(); j++;
            if (!candidate || candidate.startsWith('#')) continue;
            url = candidate; break;
          }
          if (!url) continue;
          const isHls = /\.m3u8(\?|$)/i.test(url);
          const isHttp = /^https?:\/\//i.test(url);
          if (isHls && isHttp) entries.push({ name, url, attrs });
        }
        return entries;
      }

      function sortForNepal(entries, enabled) {
        if (!enabled) return entries.slice();
        const priority = ['NP', 'IN', 'BD', 'PK', 'LK', 'BT'];
        const score = (entry) => {
          const ccRaw = entry.attrs['tvg-country'] || '';
          const codes = ccRaw.split(';').map(s => s.trim().toUpperCase()).filter(Boolean);
          for (let i = 0; i < priority.length; i++) if (codes.includes(priority[i])) return i;
          return 999;
        };
        return entries.slice().sort((a, b) => {
          const sa = score(a), sb = score(b);
          return sa === sb ? a.name.localeCompare(b.name) : sa - sb;
        });
      }

      // Favorites
      const FAV_KEY = 'iptv-favorites';
      function getFavorites() { try { return JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); } catch { return []; } }
      function setFavorites(list) { localStorage.setItem(FAV_KEY, JSON.stringify(list)); }
      function isFav(url) { return getFavorites().includes(url); }
      function toggleFav(url) {
        const favs = getFavorites();
        const idx = favs.indexOf(url);
        if (idx >= 0) favs.splice(idx, 1); else favs.push(url);
        setFavorites(favs);
      }

      // Category filter
      let activeCategory = 'all';
      function matchCategory(entry) {
        const name = entry.name.toLowerCase();
        if (activeCategory === 'cricket') return /cricket|willow|star sports|ten sports/.test(name);
        if (activeCategory === 'football') return /football|soccer|bein|premier|laliga|bundesliga|serie a/.test(name);
        return true;
      }

      // Data + rendering
      let allEntries = [];

      function renderList() {
        const q = (searchEl.value || '').trim().toLowerCase();
        const onlyFav = onlyFavEl.checked;
        const entries = sortForNepal(allEntries, nepalFirstEl.checked).filter(e => {
          if (q && !(`${e.name} ${(e.attrs['tvg-country']||'')}`.toLowerCase().includes(q))) return false;
          if (!matchCategory(e)) return false;
          if (onlyFav && !isFav(e.url)) return false;
          return true;
        });

        channelListEl.innerHTML = '';
        if (!entries.length) {
          channelListEl.innerHTML = '<div class="muted" style="padding:8px;">No channels match your filters.</div>';
          return;
        }

        entries.forEach((entry) => {
          const country = (entry.attrs['tvg-country'] || '').split(';')[0].toUpperCase();
          const logo = entry.attrs['tvg-logo'] || '';
          const card = document.createElement('div');
          card.className = 'channel-card';
          card.innerHTML = `
            <img class="channel-logo" src="${logo}" alt="logo" onerror="this.src='';" />
            <div>
              <div class="channel-title">${flagFor(country)} ${entry.name}</div>
              <div class="channel-meta">${country || 'â€”'} ${entry.attrs['group-title'] ? 'â€¢ ' + entry.attrs['group-title'] : ''}</div>
            </div>
            <div class="star ${isFav(entry.url) ? '' : 'inactive'}" title="Toggle favorite">â˜…</div>
          `;

          const starEl = card.querySelector('.star');
          starEl.addEventListener('click', (ev) => {
            ev.stopPropagation();
            toggleFav(entry.url);
            starEl.classList.toggle('inactive');
            if (onlyFavEl.checked && starEl.classList.contains('inactive')) card.remove();
          });

          card.addEventListener('click', () => playEntry(entry));
          channelListEl.appendChild(card);
        });
      }

      function playEntry(entry) {
        nowPlayingEl.textContent = `Now playing: ${entry.name}`;
        player.src({ src: entry.url, type: 'application/x-mpegURL' });
        player.play().catch(() => {});
      }

      async function loadPlaylistFromUrl(url) {
        setStatus('Fetching playlistâ€¦');
        try {
          const res = await fetch(url, { mode: 'cors' });
          if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
          const text = await res.text();
          allEntries = parseM3U(text);
          setStatus(`Loaded ${allEntries.length} HLS channels âœ…`);
          renderList();
        } catch (err) {
          console.error(err);
          setStatus('Failed to fetch playlist. See console for details.', true);
          alert('Could not fetch the playlist.\n\nPossible reasons: CORS, network, or URL issue.\nTry loading a local .m3u file or your own hosted URL.');
        }
      }

      function loadPlaylistFromFile(file) {
        if (!file) return;
        setStatus('Reading local playlistâ€¦');
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const text = String(reader.result || '');
            allEntries = parseM3U(text);
            setStatus(`Loaded ${allEntries.length} channels from local file âœ…`);
            renderList();
          } catch (e) {
            console.error(e);
            setStatus('Failed to parse local playlist', true);
            alert('Could not parse the selected file as M3U.');
          }
        };
        reader.onerror = () => setStatus('Failed to read local file', true);
        reader.readAsText(file);
      }

      // Events
      reloadBtn.addEventListener('click', () => loadPlaylistFromUrl(DEFAULT_PLAYLIST_URL));
      loadUrlBtn.addEventListener('click', () => {
        const url = (altUrlEl.value || '').trim();
        if (!url) { alert('Please paste a .m3u URL first.'); return; }
        loadPlaylistFromUrl(url);
      });
      localFileEl.addEventListener('change', (e) => loadPlaylistFromFile(e.target.files && e.target.files[0]));

      nepalFirstEl.addEventListener('change', renderList);
      searchEl.addEventListener('input', renderList);
      clearSearchBtn.addEventListener('click', () => { searchEl.value = ''; renderList(); });
      onlyFavEl.addEventListener('change', renderList);

      document.querySelectorAll('.chip').forEach(ch => {
        ch.addEventListener('click', () => {
          document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          ch.classList.add('active');
          activeCategory = ch.getAttribute('data-cat');
          renderList();
        });
      });

      // Initial load
      loadPlaylistFromUrl(DEFAULT_PLAYLIST_URL);
    </script>
  </body>
</html>